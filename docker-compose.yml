version: '3.8'

services:
  postgres:
    image: postgres:14-alpine
    container_name: ehrms-postgres
    environment:
      POSTGRES_USER: ehrms
      POSTGRES_PASSWORD: ehrms_dev_password
      POSTGRES_DB: ehrms
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations/database/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ehrms"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: ehrms-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  mongodb:
    image: mongo:6
    container_name: ehrms-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ehrms
      MONGO_INITDB_ROOT_PASSWORD: ehrms_dev_password
      MONGO_INITDB_DATABASE: ehrms
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: ehrms-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ehrms
      RABBITMQ_DEFAULT_PASS: ehrms_dev_password
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  kong:
    build:
      context: ./infrastructure/api-gateway
      dockerfile: Dockerfile.kong-with-plugins
    container_name: ehrms-kong
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/kong.yml
      KONG_PLUGINS: bundled,jwt-validator,proxy-cache
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_ADMIN_GUI_URL: http://localhost:8002
      KONG_PROXY_LISTEN: 0.0.0.0:8000
      JWT_SECRET: ${JWT_SECRET:-dev-secret-change-in-production}
    ports:
      - "8000:8000"  # Proxy port
      - "8443:8443"  # Proxy SSL port
      - "8001:8001"  # Admin API port
      - "8444:8444"  # Admin API SSL port
      - "8002:8002"  # Admin GUI port
    volumes:
      - ./infrastructure/api-gateway/kong.yml:/kong/kong.yml:ro
      # Cloudflare Origin Certificate volume
      # In production, mount certificates from secure storage (e.g., AWS Secrets Manager, SSM)
      # For local development, create ./infrastructure/api-gateway/ssl/ directory with certificates
      - ./infrastructure/api-gateway/ssl:/usr/local/kong/ssl:ro
    depends_on:
      - postgres
      - redis
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

volumes:
  postgres_data:
  redis_data:
  mongodb_data:
  rabbitmq_data:
  kong_data:

networks:
  default:
    name: ehrms-network

