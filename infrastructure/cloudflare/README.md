# Cloudflare SSL/TLS Configuration

This directory contains documentation and configuration for Cloudflare SSL/TLS setup for the EHRMS infrastructure.

## Overview

Cloudflare provides SSL/TLS encryption for traffic between end users and Cloudflare's edge network (Universal SSL), and between Cloudflare and origin servers (Origin Certificates). This configuration implements:

1. **Cloudflare Universal SSL**: Automatically enabled for end-user to Cloudflare connections
2. **Cloudflare Origin Certificates**: Secure connections between Cloudflare and origin servers (AWS ALB and Kong API Gateway)
3. **DNS Management**: Automated DNS record configuration via Terraform
4. **SSL/TLS Settings**: Configured for optimal security (Full mode, TLS 1.2+, TLS 1.3 enabled)

## Architecture

```
End User (HTTPS)
    ↓
Cloudflare Edge (Universal SSL)
    ↓
Cloudflare Origin Certificate
    ↓
AWS ALB (HTTPS Port 443)
    ↓
Kong API Gateway (HTTPS Port 8443)
    ↓
Backend Microservices
```

## Prerequisites

Before configuring Cloudflare SSL/TLS, ensure you have:

1. **Cloudflare Account**: Active Cloudflare account
2. **Domain Added**: Domain added to Cloudflare with nameservers configured
3. **Cloudflare API Token**: API token with the following permissions:
   - Zone:Zone:Read
   - Zone:DNS:Edit
   - Zone:SSL and Certificates:Edit
   - Account:Cloudflare Tunnel:Edit (if using tunnels)
4. **Cloudflare Zone ID**: Zone ID for your domain (found in Cloudflare dashboard)
5. **AWS Credentials**: Configured AWS credentials for Terraform
6. **Terraform State Backend**: Configured S3 backend for Terraform state

## Getting Started

### 1. Create Cloudflare API Token

1. Log in to Cloudflare dashboard
2. Go to **My Profile** → **API Tokens**
3. Click **Create Token**
4. Use **Edit zone DNS** template or create custom token with:
   - Zone:Zone:Read
   - Zone:DNS:Edit
   - Zone:SSL and Certificates:Edit
5. Copy the token (you won't be able to see it again)

### 2. Get Cloudflare Zone ID

1. In Cloudflare dashboard, select your domain
2. Scroll down to **API** section on the right sidebar
3. Copy the **Zone ID**

### 3. Configure Terraform Variables

Create a `terraform.tfvars` file or set environment variables:

```hcl
cloudflare_api_token = "your-cloudflare-api-token"
cloudflare_zone_id   = "your-zone-id"
cloudflare_domain     = "api.example.com"
environment          = "production"
aws_region           = "us-gov-west-1"
```

**Security Note**: Never commit `terraform.tfvars` with sensitive values. Use Terraform Cloud, AWS Secrets Manager, or environment variables for production.

### 4. Initialize and Apply Terraform

```bash
cd infrastructure/terraform

# Initialize Terraform providers
terraform init

# Review the plan
terraform plan

# Apply the configuration
terraform apply
```

This will create:
- Cloudflare Origin Certificate
- DNS records (A/CNAME) pointing to ALB
- SSL/TLS settings (Full mode, TLS 1.2+)
- AWS ACM certificate import
- ALB HTTPS listener configuration

### 5. Verify Configuration

#### Check Cloudflare DNS Records

```bash
# Get DNS record information from Terraform outputs
terraform output cloudflare_dns_record_id
terraform output cloudflare_dns_record_name
```

Or verify in Cloudflare dashboard:
1. Go to **DNS** → **Records**
2. Verify A/CNAME record points to your ALB DNS name
3. Ensure record is **Proxied** (orange cloud icon)

#### Check SSL/TLS Settings

1. Go to **SSL/TLS** → **Overview**
2. Verify SSL/TLS encryption mode is set to **Full** or **Full (strict)**
3. Check **Edge Certificates** - Universal SSL should be active
4. Go to **Origin Server** - verify Origin Certificate is listed

#### Test HTTPS Connection

```bash
# Test HTTPS connection through Cloudflare
curl -v https://api.example.com/status

# Verify certificate chain
openssl s_client -connect api.example.com:443 -showcerts
```

## Certificate Management

### Cloudflare Origin Certificate

The Origin Certificate is automatically generated by Terraform and:
- Valid for 15 years (5475 days) by default
- Stored securely in AWS Systems Manager Parameter Store
- Automatically imported to AWS Certificate Manager for ALB use
- Configured in Kong API Gateway

### Certificate Storage Locations

1. **AWS Systems Manager Parameter Store**:
   - Certificate: `/ehrms/{environment}/cloudflare/origin-cert`
   - Private Key: `/ehrms/{environment}/cloudflare/origin-key`

2. **AWS Certificate Manager**:
   - Certificate ARN available via Terraform output: `cloudflare_origin_certificate_arn`

3. **Kong API Gateway**:
   - Certificate path: `/usr/local/kong/ssl/cloudflare-origin.crt`
   - Private key path: `/usr/local/kong/ssl/cloudflare-origin.key`

### Retrieving Certificates

#### From AWS Systems Manager

```bash
# Get certificate
aws ssm get-parameter \
  --name "/ehrms/production/cloudflare/origin-cert" \
  --with-decryption \
  --query 'Parameter.Value' \
  --output text

# Get private key
aws ssm get-parameter \
  --name "/ehrms/production/cloudflare/origin-key" \
  --with-decryption \
  --query 'Parameter.Value' \
  --output text
```

#### From Terraform Outputs

```bash
# Get SSM parameter paths
terraform output cloudflare_origin_certificate_ssm_path
terraform output cloudflare_origin_key_ssm_path
```

### Certificate Renewal

Cloudflare Origin Certificates are valid for 15 years, so renewal is rarely needed. However, if you need to rotate certificates:

1. Update Terraform configuration (certificate will be regenerated)
2. Run `terraform apply`
3. Restart Kong API Gateway to load new certificate
4. ALB will automatically use new certificate from ACM

## SSL/TLS Modes

### Full Mode (Recommended)

- **End-to-End Encryption**: Encrypted from user to origin
- **Certificate Validation**: Cloudflare validates origin certificate
- **Use Case**: When origin has valid SSL certificate (Cloudflare Origin Certificate)

### Full (Strict) Mode

- **Strict Validation**: Cloudflare validates certificate against trusted CA
- **Use Case**: When using publicly trusted certificates on origin
- **Note**: Cloudflare Origin Certificates are not publicly trusted, so use "Full" mode

### Flexible Mode

- **Partial Encryption**: Encrypted from user to Cloudflare only
- **Not Recommended**: Traffic from Cloudflare to origin is unencrypted
- **Use Case**: Legacy systems without SSL capability

## DNS Configuration

### Automatic DNS Management

Terraform automatically creates DNS records:
- **A/CNAME Record**: Points to ALB DNS name
- **Proxied**: Enabled (orange cloud) for DDoS protection and caching
- **TTL**: Automatic (managed by Cloudflare)

### Manual DNS Configuration

If you prefer manual DNS management:

1. Disable Terraform DNS resources (comment out in `cloudflare.tf`)
2. Manually create DNS record in Cloudflare dashboard:
   - Type: CNAME
   - Name: `api` (or your subdomain)
   - Target: ALB DNS name (from Terraform output)
   - Proxy: Enabled

## Security Best Practices

1. **API Token Security**:
   - Store Cloudflare API token in secure secret management
   - Use least privilege principle for token permissions
   - Rotate tokens regularly

2. **Certificate Security**:
   - Never commit certificates or private keys to version control
   - Use AWS Systems Manager Parameter Store or Secrets Manager
   - Restrict access to certificate storage locations

3. **SSL/TLS Configuration**:
   - Use "Full" mode (not "Flexible")
   - Enable TLS 1.2 minimum
   - Enable TLS 1.3
   - Use strong cipher suites

4. **IP Restrictions** (Optional):
   - Restrict ALB access to Cloudflare IP ranges only
   - See commented section in `alb.tf` for implementation

5. **Monitoring**:
   - Monitor certificate expiration (15 years, but monitor anyway)
   - Set up alerts for SSL/TLS errors
   - Monitor Cloudflare analytics for suspicious traffic

## Troubleshooting

### Certificate Not Working

1. **Check Certificate Installation**:
   ```bash
   # Verify certificate exists in Kong
   docker exec ehrms-kong ls -la /usr/local/kong/ssl/
   
   # Check Kong SSL configuration
   docker exec ehrms-kong kong config -c /etc/kong/kong.conf | grep ssl
   ```

2. **Verify DNS Resolution**:
   ```bash
   # Check DNS resolution
   dig api.example.com
   nslookup api.example.com
   ```

3. **Check Cloudflare SSL Mode**:
   - Ensure SSL mode is set to "Full" (not "Flexible")
   - Verify Origin Certificate is active in Cloudflare dashboard

### DNS Not Resolving

1. **Check DNS Records**:
   ```bash
   terraform output cloudflare_dns_record_id
   ```

2. **Verify Nameservers**:
   - Ensure domain nameservers point to Cloudflare
   - Check nameserver configuration in domain registrar

3. **Check DNS Propagation**:
   ```bash
   dig @1.1.1.1 api.example.com
   ```

### ALB Not Accepting Connections

1. **Check Security Groups**:
   - Verify security group allows port 443 from Cloudflare IPs
   - Check ALB listener configuration

2. **Verify Certificate in ACM**:
   ```bash
   aws acm list-certificates --region us-gov-west-1
   terraform output cloudflare_origin_certificate_arn
   ```

3. **Check ALB Health**:
   ```bash
   aws elbv2 describe-load-balancers --region us-gov-west-1
   ```

## Terraform Outputs

Useful Terraform outputs for certificate management:

```bash
# Certificate information
terraform output cloudflare_origin_certificate_id
terraform output cloudflare_origin_certificate_arn
terraform output cloudflare_origin_certificate_ssm_path
terraform output cloudflare_origin_key_ssm_path

# DNS information
terraform output cloudflare_dns_record_id
terraform output cloudflare_dns_record_name
terraform output cloudflare_domain

# ALB information
terraform output alb_dns_name
terraform output alb_arn
terraform output alb_https_listener_arn
```

## References

- [Cloudflare Origin Certificates](https://developers.cloudflare.com/ssl/origin-configuration/origin-ca/)
- [Cloudflare SSL/TLS Modes](https://developers.cloudflare.com/ssl/origin-configuration/ssl-modes/)
- [Cloudflare API Documentation](https://developers.cloudflare.com/api/)
- [Terraform Cloudflare Provider](https://registry.terraform.io/providers/cloudflare/cloudflare/latest/docs)

